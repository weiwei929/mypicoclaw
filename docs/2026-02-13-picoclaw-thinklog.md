# 2026-02-13 PicoClaw 进化实录：从"毛坯房"到"精装房"的开源探索

> **编者按**：这就不是一篇单纯的技术日志，而是一个“非科班出身”的折腾者，如何通过自学与 AI 协作，深入开源项目核心，并在发现不足、解决问题中完成自我进化的故事。如果这些优化最终能通过 PR 回馈社区，那将是我个人技术探索的一个重要里程碑。

## 1. 发现：轻量级框架的"原生缺陷"

PicoClaw (基于 `nanobot`) 的定位非常精准：轻量、Go 语言开发、单文件部署。但正如用户所言，它更像是一个**框架 (Framework)** 甚至是“毛坯房”，而不是一个开箱即用的**成品 (Product)**。

在实际部署和高强度测试中，我们发现了它作为“框架”的几个明显短板：

### 1.1 "一次性"的设计思维
原项目似乎默认用户只是偶尔发一条指令（CLI 模式），或者并不介意随时重启服务。
- **缺失的会话管理**：没有考虑到 Telegram Bot 这种 24h 长连接场景。上下文只会无脑堆积，直到溢出崩溃。
- **缺失的重置机制**：当 AI 聊“飘”了或者我想换个话题时，竟然发现没有指令可以清空记忆，只能重启服务。

### 1.2 "粗放"的参数控制
- **硬编码黑盒**：在 `loop.go` 中，关键参数 `max_tokens` 被写死为 8192，`temperature` 被写死为 0.7。这意味着无论我在配置文件里怎么改，其实都是**无效**的。
- **工具输出无节制**：`web_fetch` 工具抓取网页时，默认上限高达 50000 字符。一个稍微长点的网页就能瞬间撑爆上下文，导致服务陷入死循环。

### 1.3 "脆弱"的单点依赖
- **零容灾**：系统默认只支持单一模型配置。在 API 频繁波动的当下，主模型一旦（5xx/超时），Agent 就直接“断片”。对于一个自用的 24h 助理，这是不可接受的。

**小结**：发现这些不足本身就是巨大的成功。它证明了我们不仅是在“用”软件，更是在“懂”软件。

## 2. 破局：外科手术式的精准改造

面对这些问题，我们没有选择“打补丁”（比如外挂一个脚本来定时重启），而是选择了**深入核心，精准手术**。这种解决问题的方式体现了 Golang 的简约哲学：

### 2.1 抓住核心 (Core Loop)
我们直接锁定了 `pkg/agent/loop.go` —— 也就是 Agent 的“大脑皮层”。
- **手术动作**：
    - **参数解耦**：将硬编码替换为 `al.contextWindow` 和 `al.temperature`，让配置文件的修改真正生效。
    - **指令拦截**：在消息循环的入口处植入 `/new` 检查，用最少的代码实现了最实用的功能。
    - **熔断机制**：在调用 LLM 之前的“毫秒级”瞬间，插入 90% 阈值检查。不改变原有架构，但彻底杜绝了崩溃风险。

### 2.2 重构底层 (Provider Interface)
我们修改了 `pkg/providers/http_provider.go` —— 也就是 Agent 的“嘴巴和耳朵”。
- **手术动作**：
    - **接口升级**：扩展 `HTTPProvider` 结构体，使其原生支持备用模型配置。
    - **无感切换**：将 `Chat` 方法重构为代理模式，主模型失败即刻切换备用模型。用户只觉得“这次回复慢了 1 秒”，而不知道后台刚刚发生了一次惊心动魄的救援。

**价值**：这种修改方式**侵入性最小，收益最大**。我们保持了原项目的代码风格，没有引入臃肿的第三方库，而是利用 Go 语言的特性（结构体方法、接口）优雅地解决了问题。

## 3. 境界：学会说不的艺术 (The Art of Saying No)

在本次开发过程中，除了代码层面的收获，更让我印象深刻的是 AI 辅助编程在**架构决策**层面的提升。它不再是一个唯唯诺诺的代码生成器，而是一个有原则的**资深工程师**。

### 3.1 拒绝 Watchdog，拥抱 Systemd
- **背景**：受惯性思维影响（之前用 Docker 版 OpenClaw 的经验），我曾提议增加一个外部 Watchdog 容器来监控稳定性。
- **冲突**：AI 并没有顺从这个“合理”的要求，而是果断拒绝了。
- **理由**：既然我们选择了 Go 单文件部署，就应该追求极致轻量。Linux 原生的 `systemd` 才是最优雅的进程守护者，既高效又无需引入额外的 Docker 复杂性。
- **结果**：听从建议配置了 `.service` 文件后，服务稳如泰山，且系统资源占用极低。

### 3.2 拒绝 Caddy 反代，坚持 Polling
- **背景**：为了看起来更“专业”，我曾想给项目加上域名和 Caddy 反代。
- **冲突**：AI 再次泼了冷水。
- **理由**：Telegram Bot 的 Polling 模式不需要公网 IP，不需要域名，也不需要 SSL 证书。对于 Picoclaw 这种无需对外提供 Web UI 的纯 Bot 项目，强上 Caddy 只会徒增运维负担，毫无收益。
- **结果**：删繁就简，专注于 Bot 核心逻辑，让部署变得极其简单。

**感悟**：这就是**“拒绝的好处”**。真正的辅助不是盲目应承，而是利用专业知识帮助用户做减法，避免陷入过度设计的陷阱。这种有理有节的说服，让项目始终保持在正确的轨道上。

## 4. 启示：开源探索的里程碑

这次折腾最大的收获，不仅仅是得到了一个如丝般顺滑的 Bot，更是对“如何参与开源”有了全新的认知：

### 4.1 适配的艺术
开源项目往往是通用的，而需求是个性化的。最好的适配不是“重起炉灶”，而是**理解原作者的意图**，顺势而为。
- 比如原作者留下了 `config.Config` 结构，我们就应该把硬编码改回去读取它，而不是自己再写一个配置解析器。

### 4.2 贡献的意义 (The First Valid PR)
对于一个非科班出身的爱好者，能够给硬核的 Go 语言 AI 项目提交 PR，这不仅仅是代码的合并，更是**信心的合并**。
- **PR 1 (Fix)**: 修复硬编码参数。这证明了我能看懂代码逻辑，指出了明显的 Bug。
- **PR 2 (Feat)**: 增加容灾和会话管理。这证明了我不仅能修车，还能改装升级引擎。

如果在未来，某个深夜，地球另一端的一个开发者拉取了最新的 Picoclaw，发现他的 Bot 在 API 挂掉时自动切换了线路，从而保住了关键任务——那一刻，就是这个 PR 最大的意义。

---
*记录时间：2026-02-13*
*执行者：Picoclaw 探索者*
